# This is exclusively windows containers?
# 
# resources:
#   containers:
#   - container: linux-anvil  # identifier (no spaces allowed)
#     image: condaforge/linux-anvil  # container image name
#     localImage: false  # whether to build the image locally instead of pulling from a registry

jobs:
- job: win_64
  pool:
    # vmImage: vs2015-win2012r2
    vmImage: vs2017-win2016
  strategy:
    maxParallel: 4  
    matrix:
      python27:
        CONFIG: win_c_compilervs2008python2.7
      python35:
        CONFIG: win_c_compilervs2015python3.5
      python36:
        CONFIG: win_c_compilervs2015python3.6
  steps:
    - script: choco install vcpython27
      condition: contains(variables['CONFIG'], 'vs2008')

    # - powershell: |
    #     $client = new-object System.Net.WebClient
    #     $client.DownloadFile("https://raw.githubusercontent.com/dask/dask-image/master/.appveyor_support/install_miniconda.bat","$(System.DefaultWorkingDirectory)\install_miniconda.bat")

    # - script: install_miniconda.bat
    - task: CondaEnvironment@1

    - script: set PYTHONUNBUFFERED=1

    # Add our channels.
    - script: conda.exe config --set show_channel_urls true
    - script: conda.exe config --remove channels defaults
    - script: conda.exe config --add channels defaults
    - script: conda.exe config --add channels conda-forge

    # Configure the VM.
    - script: conda.exe install -n root --quiet --yes conda-forge-ci-setup=2
    - script: run_conda_forge_build_setup
    - script: conda.exe build recipe -m .ci_support\%CONFIG%.yaml --quiet

- job: osx_64
  pool:
    vmImage: xcode9-macos10.13
  strategy:
    maxParallel: 4  
    matrix:
      python27:
        CONFIG: osx_python2.7
      python35:
        CONFIG: osx_python3.5
      python36:
        CONFIG: osx_python3.6
  steps:
  - script: |
      echo ""
      echo "Removing homebrew from Travis CI to avoid conflicts."
      curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/uninstall > ~/uninstall_homebrew
      chmod +x ~/uninstall_homebrew
      ~/uninstall_homebrew -fq
      rm ~/uninstall_homebrew
    displayName: Remove homebrew

  - script: |
      curl -L https://github.com/phracker/MacOSX-SDKs/releases/download/10.13/MacOSX10.9.sdk.tar.xz -O MacOSX10.9.sdk.tar.xz
      sudo tar -xf MacOSX10.9.sdk.tar.xz -C /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs

  - script: sudo chown -R ${USER} /usr/local/miniconda
    displayName: Chown conda

  - task: CondaEnvironment@1
    inputs:
      packageSpecs: 'python=3.6' # Optional

  - script: |
      ls /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs
      echo "1"

  - script: |
      echo ""
      echo "Configuring conda."
      
      conda install --yes --quiet conda-forge::conda-forge-ci-setup=2
      setup_conda_rc ./ ./recipe ./.ci_support/${CONFIG}.yaml

      source run_conda_forge_build_setup
    displayName: Configure conda and conda-build

  - script: |
      mangle_compiler ./ ./recipe ./.ci_support/${CONFIG}.yaml
    displayName: Mangle compiler

  - script: |
      make_build_number ./ ./recipe ./.ci_support/${CONFIG}.yaml
    displayName: Generate build number clobber

  - script: | 
      conda build ./recipe -m ./.ci_support/${CONFIG}.yaml --clobber-file ./.ci_support/clobber_${CONFIG}.yaml
    displayName: Build recipe

  - script: |
      upload_package ./ ./recipe ./.ci_support/${CONFIG}.yaml
    displayName: Upload recipe


- job: linux_64
  pool:
    vmImage: ubuntu-16.04
  strategy:
    maxParallel: 4
    matrix:
      python27:
        CONFIG: linux_python2.7
      python35:
        CONFIG: linux_python3.5
      python36:
        CONFIG: linux_python3.6
  steps:
  - script: sudo pip install --upgrade pip
  - script: sudo pip install setuptools
  - script: sudo '.circleci/run_docker_build.sh'
